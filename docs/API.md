# CyberDevStudio API Reference

This reference summarizes the externally supported HTTP and JSON-RPC surfaces. All endpoints require TLS termination in production and accept JWT bearer tokens generated by the auth service unless noted otherwise.

## Authentication Service (`auth`)

Base URL: `http://AUTH_HOST:6971`

| Method | Path | Description |
| --- | --- | --- |
| `POST` | `/auth/register` | Register a new user. Requires `username`, `password`, and optional `role`. Returns JWT. |
| `POST` | `/auth/login` | Exchange credentials for a JWT. |
| `GET` | `/auth/api-keys` | List API keys for the authenticated user. Admins receive entries for all users. |
| `POST` | `/auth/api-keys` | Create a named API key. Returns the plaintext token once. |
| `DELETE` | `/auth/api-keys/:id` | Revoke a key by identifier. |
| `GET` | `/health` | Service health indicator. |

JWT claims:

```json
{
  "sub": 1,
  "username": "dev",
  "role": "developer",
  "exp": 1717468800,
  "iss": "cyber-dev-studio"
}
```

## API Gateway (`api`)

Base URL: `http://API_HOST:6813`

### JSON-RPC Endpoint

- `POST /rpc`
- Content-Type: `application/json`
- Authentication: `Authorization: Bearer <JWT>` or `X-API-Key: <token>`

#### Sample Request

```json
{
  "jsonrpc": "2.0",
  "id": "run-sample",
  "method": "run.exec",
  "params": {
    "program": "/bin/sh",
    "args": ["-c", "echo hello"],
    "timeout_ms": 2000
  }
}
```

#### Standard Error Object

```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32602,
    "message": "validation failed",
    "data": {
      "field": "program",
      "reason": "not whitelisted"
    }
  },
  "id": "run-sample"
}
```

### Exposed Methods

| Method | Description |
| --- | --- |
| `fs.read`, `fs.write`, `fs.list`, `fs.delete`, `fs.mkdir`, `fs.copy`, `fs.move` | Managed filesystem operations inside the sandbox root. |
| `run.exec`, `run.describe` | Spawn and inspect host execution sandboxes. |
| `wasm.invoke`, `wasm.describe` | Invoke WebAssembly modules with bounded memory and fuel. |
| `micro.start`, `micro.execute`, `micro.stop`, `micro.describe` | Manage micro VM sessions running Python or Node code. |
| `agent.dispatch`, `agent.status`, `agent.history`, `agent.cancel`, `agent.list` | Task orchestration across specialist agents. |
| `project.create`, `project.open`, `project.list`, `project.delete`, `project.file.save`, `project.file.read`, `project.file.delete` | Project catalog and file persistence. |
| `llm.chat`, `llm.completion`, `llm.embed`, `llm.list_models`, `llm.download`, `llm.start`, `llm.stop`, `llm.status` | Proxy to the LLM service with token accounting and rate enforcement. |

### Metrics

- `GET /metrics` — Prometheus exposition.
- `GET /health` — readiness indicator.
- `GET /ws` — WebSocket endpoint for streaming RPC notifications.

## LLM Service (`llmserver`)

Base URL: `http://LLM_HOST:6988`

### Public Endpoints

| Method | Path | Description |
| --- | --- | --- |
| `POST` | `/v1/chat/completions` | OpenAI-compatible chat completions. Requires `model` and `messages`. |
| `POST` | `/v1/completions` | Text completion API. |
| `POST` | `/v1/embeddings` | Embedding generation. |
| `GET` | `/metrics` | Prometheus metrics (`llm_requests_total`, `llm_tokens_generated`, etc.). |

### Admin Endpoints

Require `Authorization: Bearer <admin JWT>` with admin role.

| Method | Path | Description |
| --- | --- | --- |
| `POST` | `/admin/download` | Fetch a GGUF artifact from Hugging Face. |
| `POST` | `/admin/load` | Load a model into memory with tuning parameters. |
| `POST` | `/admin/unload` | Unload the active model. |
| `GET` | `/admin/models` | Enumerate downloaded and loaded models. |
| `GET` | `/admin/status` | Return runtime resource utilization and active sessions. |

### Streaming WebSocket

- Path: `/v1/stream`
- Protocol: JSON lines with incremental deltas and token counts.
- Disconnect occurs automatically after `maxStreamingSeconds` per configuration.

## Studio UI

- Served via NGINX on port `6711`.
- Static assets built with Vite; API requests proxied directly to the gateway.
- WebSocket connections established to `ws://API_HOST:6813/ws`.

## Rate Limiting and Accounting

- Every LLM RPC decrements `users.token_balance`. Calls are rejected with HTTP 429 when balance is insufficient.
- Token usage is recorded in `tokens_used` with request identifier, user, model, and timestamp for auditing.
- API keys are hashed with SHA-256 before persistence. Plaintext tokens are never stored.

